#!/usr/bin/make -f

DEB_HOST_ARCH ?= $(shell dpkg-architecture -qDEB_HOST_ARCH)
SOURCE   := $(shell dpkg-parsechangelog | sed -ne 's,^Source: *\(.*\)$$,\1,p')
VERSION_DEBIAN := $(shell dpkg-parsechangelog | sed -ne 's,^Version: *\(.*\)$$,\1,p')
VERSION_FILE := $(shell echo "$(VERSION_DEBIAN)" | sed -e 's,^[0-9]*:,,' -e 's,-[^-]*$$,,')

BUILD_DIR = debian/build
STAMPS_DIR = debian/stamps
SOURCE_FILES = $(filter-out .svn .svk debian, $(wildcard * .[^.]*))

CONFIGURE_ARGS := \
	--disable_kernel_check \
	--kernel_src=$(CURDIR) \
	--kernel_build=$(CURDIR) \
	--libexecdir=/usr/lib/openais \
	--nsprincdir=/usr/include/nspr \
	--nssincdir=/usr/include/nss \
	--sbindir=/usr/sbin \
	--without_kernel_modules

ifneq (,$(filter $(DEB_HOST_ARCH), amd64 i386)) 
CONFIGURE_ARGS += \
	--enable_xen
endif

setup: $(STAMPS_DIR)/setup

$(STAMPS_DIR)/setup: DIR = $(BUILD_DIR)/build
$(STAMPS_DIR)/setup: $(BUILD_DIR) $(STAMPS_DIR)
	dh_testdir
	@rm -rf $(DIR)
	mkdir $(DIR)
	cp -a $(SOURCE_FILES) $(DIR)
	cd $(DIR); QUILT_PATCHES=$(CURDIR)/debian/patches quilt --quiltrc /dev/null push -a || test $$? = 2
	cd $(DIR); ./configure $(CONFIGURE_ARGS)
	touch $@

build: $(STAMPS_DIR)/build

$(STAMPS_DIR)/build: DIR = $(BUILD_DIR)/build
$(STAMPS_DIR)/build: $(STAMPS_DIR)/setup
	dh_testdir
	$(MAKE) -C $(DIR) all
	touch $@

$(BUILD_DIR) $(STAMPS_DIR):
	@[ -d $@ ] || mkdir $@

clean:
	dh_testdir
	rm -rf $(BUILD_DIR) $(STAMPS_DIR)
	dh_clean

maintainerclean:
	rm -rf $(SOURCE_FILES)

install: DIR = $(BUILD_DIR)/build
install: INSTALL_DIR = $(BUILD_DIR)/install
install: $(STAMPS_DIR)/build
	dh_testdir
	dh_testroot
	dh_clean -k
	
	$(MAKE) -C $(DIR) install DESTDIR=$(CURDIR)/debian/tmp/
	
	# manual craft
	install -d -m 0755 debian/tmp/etc/cluster
	install -m 0640 debian/gnbdexports.conf debian/tmp/etc/cluster/gnbdexports.conf
	install -m 0640 debian/gnbdimports.conf debian/tmp/etc/cluster/gnbdimports.conf
	
	mv debian/tmp/etc/udev/rules.d/51-dlm.rules debian/tmp/etc/udev/rules.d/45-dlm.rules
	
	dh_install --sourcedir=debian/tmp --list-missing
	
	# install gfs and gnbd kernel sources
	mkdir -p debian/redhat-cluster-source/usr/src/modules/redhat-cluster/debian
	
	# copy the source
	mkdir -p debian/redhat-cluster-source/usr/src/modules/redhat-cluster/gfs
	cp -a gfs-kernel/src/gfs/* \
		debian/redhat-cluster-source/usr/src/modules/redhat-cluster/gfs/
	
	mkdir -p debian/redhat-cluster-source/usr/src/modules/redhat-cluster/gnbd
	cp -a gnbd-kernel/src/* \
		debian/redhat-cluster-source/usr/src/modules/redhat-cluster/gnbd/
	
	# prepare the debian dir
	cd debian ; \
	cp compat copyright redhat-cluster-modules-_KVERS_.postinst changelog \
		control.modules.in redhat-cluster-source/usr/src/modules/redhat-cluster/debian
	cp debian/redhat-cluster-source.README.Debian \
		debian/redhat-cluster-source/usr/src/modules/redhat-cluster/debian/README.Debian
	cp debian/redhat-cluster-source.rules \
		debian/redhat-cluster-source/usr/src/modules/redhat-cluster/debian/rules
	chmod 755 debian/redhat-cluster-source/usr/src/modules/redhat-cluster/debian/rules
	cp debian/redhat-cluster-source.Makefile \
		debian/redhat-cluster-source/usr/src/modules/redhat-cluster/Makefile
	
	# tar it up
	cd debian/redhat-cluster-source/usr/src/ ;  \
		tar cjf redhat-cluster.tar.bz2 modules/redhat-cluster/
	rm -rf debian/redhat-cluster-source/usr/src/modules
		
	install -D -m 755 debian/modass.redhat-cluster-source \
		debian/redhat-cluster-source/usr/share/modass/overrides/redhat-cluster-source
		
	dh_installdirs
	dh_link
	dh_installdocs -A debian/README.Debian debian/README.source
	dh_installchangelogs
	dh_installdebconf
	dh_installinit -p cman --no-start --no-restart-on-upgrade -- start 61 S . start 5 0 6 .
	dh_installinit -p gnbd-server --no-start --no-restart-on-upgrade -- start 63 S . start 3 0 6 .
	dh_installinit -p gnbd-client --no-start --no-restart-on-upgrade -- start 64 S . start 3 0 6 .
	dh_installinit -p gfs-tools --no-start --no-restart-on-upgrade -- start 65 S . start 2 0 6 .
	dh_installinit -p gfs2-tools --no-start --no-restart-on-upgrade -- start 65 S . start 2 0 6 .
	dh_installinit -p rgmanager --no-start --no-restart-on-upgrade -- start 65 S . start 1 0 6 .

binary-arch: install
	dh_testdir
	dh_testroot
	dh_strip -a
ifeq (,$(findstring nostrip,$(DEB_BUILD_OPTIONS)))
	strip --remove-section=.comment --remove-section=.note --strip-unneeded debian/cman/usr/lib/openais/lcrso/service_cman.lcrso
endif
	dh_compress -a
	dh_fixperms -a
	dh_makeshlibs -a
	dh_shlibdeps -a -l$(CURDIR)/debian/tmp/usr/lib
	dh_installdeb -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary-indep: install
	dh_testdir
	dh_testroot
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

binary: binary-arch binary-indep 

DIR_ORIG = ../orig/$(SOURCE)-$(VERSION_FILE)
TAR_ORIG_NAME = $(SOURCE)_$(VERSION_FILE).orig.tar.gz
TAR_ORIG = $(firstword $(wildcard ../$(TAR_ORIG_NAME)) $(wildcard ../orig/$(TAR_ORIG_NAME)))

orig: $(DIR_ORIG)
	rsync --delete --exclude debian --exclude .svk --exclude .svn --link-dest=$(DIR_ORIG)/ -a $(DIR_ORIG)/ .

$(DIR_ORIG):
ifeq ($(TAR_ORIG),)
	$(error Cannot find orig tarball $(TAR_ORIG_NAME))
else   
	mkdir -p ../orig
	tar -C ../orig -xzf $(TAR_ORIG)
endif

