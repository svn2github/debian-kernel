#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
# export DH_VERBOSE=1

include /usr/share/dpatch/dpatch.make

DEB_HOST_ARCH ?= $(shell dpkg-architecture -qDEB_HOST_ARCH)

ifneq (,$(findstring $(DEB_HOST_ARCH), i386))
  BUILD_XEN = --enable_xen
endif


BUILDROOT := $(shell pwd)

SOMAJOR=2
SOMINOR=0

configure: patch configure-stamp
configure-stamp:
	dh_testdir
	
	./configure --kernel_src=$(BUILDROOT) \
		    --kernel_build=$(BUILDROOT) \
		    --sbindir=/usr/sbin \
			$(BUILD_XEN) \
		    --nssincdir=/usr/include/nss \
		    --nsprincdir=/usr/include/nspr \
		    --libexecdir=/usr/lib/openais \
		    --release_major=$(SOMAJOR) \
		    --release_minor=$(SOMINOR)
	
	# disable kernel modules
	sed -i -e 's/-kernel.* \?=/& 1/g' make/defines.mk
	
	touch $@

build: configure build-stamp
build-stamp:
	dh_testdir

	$(MAKE) all

	touch $@

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	
	$(MAKE) install DESTDIR=$(BUILDROOT)/debian/tmp/
	
	# manual craft
	install -d -m 0755 debian/tmp/etc/cluster
	install -m 0640 debian/gnbdexports.conf debian/tmp/etc/cluster/gnbdexports.conf
	install -m 0640 debian/gnbdimports.conf debian/tmp/etc/cluster/gnbdimports.conf
	
	mv debian/tmp/etc/udev/rules.d/51-dlm.rules debian/tmp/etc/udev/rules.d/45-dlm.rules
	
	dh_install --sourcedir=debian/tmp --list-missing
	
	# install gfs v1 kernel source
	mkdir -p debian/gfs-source/usr/src/modules/gfs/debian
	
	# copy the source
	cp -a gfs-kernel/src/gfs/* debian/gfs-source/usr/src/modules/gfs/
	
	# prepare the debian dir
	cd debian ; \
	cp compat copyright gfs-modules-_KVERS_.postinst changelog \
		control.modules.in gfs-source/usr/src/modules/gfs/debian
	cp debian/gfs-source.README.Debian \
		debian/gfs-source/usr/src/modules/gfs/debian/README.Debian
	cp debian/gfs-source.rules \
		debian/gfs-source/usr/src/modules/gfs/debian/rules
	
	# hack to fix changelog in the module source package
	cat debian/changelog | sed -e "s/^redhat-cluster/gfs/" > \
		debian/gfs-source/usr/src/modules/gfs/debian/changelog
	
	# tar it up
	cd debian/gfs-source/usr/src/ ; tar cjf gfs.tar.bz2 modules/gfs/
	rm -rf debian/gfs-source/usr/src/modules
		
	install -D -m 755 debian/modass.gfs-source \
		debian/gfs-source/usr/share/modass/overrides/gfs-source
		
	dh_installdirs
	dh_link
	dh_installdocs
	dh_installchangelogs
	dh_installdebconf
	dh_installinit -p cman --no-start --no-restart-on-upgrade -- start 61 S . start 5 0 6 .
	dh_installinit -p gnbd-server --no-start --no-restart-on-upgrade -- start 63 S . start 3 0 6 .
	dh_installinit -p gnbd-client --no-start --no-restart-on-upgrade -- start 64 S . start 3 0 6 .
	dh_installinit -p gfs-tools --no-start --no-restart-on-upgrade -- start 65 S . start 2 0 6 .
	dh_installinit -p gfs2-tools --no-start --no-restart-on-upgrade -- start 65 S . start 2 0 6 .
	dh_installinit -p rgmanager --no-start --no-restart-on-upgrade -- start 65 S . start 1 0 6 .

binary-arch: install
	dh_testdir
	dh_testroot
	dh_strip -a
	dh_compress -a
	dh_fixperms -a
	dh_installdeb -a
	dh_makeshlibs -a
	dh_shlibdeps -a -ldebian/tmp/usr/lib -l/usr/lib/openais
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary-indep: install
	dh_testdir
	dh_testroot
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

binary: binary-arch binary-indep 

clean: unpatch
	dh_testdir
	dh_testroot
	dh_clean

	 [ ! -f make/defines.mk ] || $(MAKE) distclean

	rm -rf *-stamp
	rm -rf debian/patched

