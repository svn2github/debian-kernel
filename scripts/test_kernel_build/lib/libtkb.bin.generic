#!/bin/bash
######################################################################
# Horms                                                   October 2004
######################################################################

if [ "$LIBTKB_BIN_GENERIC" != "YES" ]; then
LIBTKB_BIN_GENERIC="YES"

. "$TKB_LIB_DIR/libtkb.generic"

declare TAG_VERSION S_DEB_VERSION S_TAG_VERSION
post_conf_setup_bin_generic ()
{
	post_conf_setup_generic

	# Using apt-get here does not work because it only
	# prints out URLs of files that need to be downloaded,
	# so if they are in the apt cache somewhere they
	# won't show up
	#N.B: this may not be in debian package order
	S_TAG_VERSION="$(wget -O - -qnv $S_DOWNDLOAD_URL | sed -ne 's/.*kernel-tree-'${VERSION}'_\([^_]*\).*/\1/ p' | sort -n | tail -1)"

	B_UPSTREAM_VERSION=$(upstream_version "$B_SRC_DIR")
	B_DEB_VERSION=$(deb_version "$B_SRC_DIR")
	if [ -z "$TAG_VERSION" ]; then
		if [ -s "$TAG_RELEASE" ]; then
			TAG_VERSION="${TAG_DATE}00"
		else
			TAG_VERSION="${TAG_RELEASE}.${TAG_DATE}00"
		fi
		B_TAG_VERSION=$(tag_version "$B_SRC_DIR")
	elif [ "$TAG_VERSION" = "SOURCE" ]; then
		B_TAG_VERSION="$S_TAG_VERSION"
	else
		B_TAG_VERSION=$(tag_version "$B_SRC_DIR")
	fi

	log "Building as $(whoami)@$(hostname) (this will be included in dmsg)";
	if [ -n "$RELEASE" ]; then
		log "Building: release packages, kernel-tree will need to be installed"
		log "Building: $KERNEL_PKG_NAME-$KERNEL_ARCH $B_DEB_VERSION"
	else
		log "Building: test packages, dependancies will be mangled"
		log "          Define RELEASE=yes in the environment to build for a release"
		log "Building: TAG_VERSION=\"$TAG_VERSION\", override in environment"
		log "Building: set to SOURCE to use same version as kernel-source"
		log "Using: kernel-source $S_TAG_VERSION"
		log "Building: $KERNEL_PKG_NAME-$KERNEL_ARCH $B_DEB_VERSION -> $B_TAG_VERSION"
	fi

}


fi # LIBTKB_BIN_GENERIC
