From: Marcelo Tosatti <marcelo.tosatti@cyclades.com>
Date: Tue, 1 Nov 2005 16:03:08 +0000 (-0200)
Subject:     [PATCH] only disallow _setting_ of function key string
X-Git-Tag: v2.4.32-rc3
X-Git-Url: http://www.kernel.org/git/?p=linux/kernel/git/marcelo/linux-2.4.git;a=commitdiff;h=f7d4ff67d9c7481f720885e5ec37111bb081921f

  [PATCH] only disallow _setting_ of function key string
  
  Mikael Pettersson <mikpe@csd.uu.se> noted that the current 2.6-git (and
  2.4) patch to disallow KDSKBSENT for unpriviledged users should be less
  restrictive allowing reading of current function key string entry, but
  not writing.
  
  Signed-off-by: Marcelo Tosatti <marcelo.tosatti@cyclades.com>
  Signed-off-by: Andrew Morton <akpm@osdl.org>
---

--- a/drivers/char/vt.c
+++ b/drivers/char/vt.c
@@ -166,6 +166,9 @@ do_kdsk_ioctl(int cmd, struct kbentry *u
 	if (i >= NR_KEYS || s >= MAX_NR_KEYMAPS)
 		return -EINVAL;	
 
+	if (!capable(CAP_SYS_TTY_CONFIG))
+		perm = 0;
+
 	switch (cmd) {
 	case KDGKBENT:
 		key_map = key_maps[s];
@@ -277,7 +280,7 @@ do_kdgkb_ioctl(int cmd, struct kbsentry 
 	int i, j, k;
 
 	if (!capable(CAP_SYS_TTY_CONFIG))
-		return -EPERM;
+		perm = 0;
 
 	/* we mostly copy too much here (512bytes), but who cares ;) */
 	if (copy_from_user(&tmp, user_kdgkb, sizeof(struct kbsentry)))
